import 'dotenv/config';
import { Client, GatewayIntentBits, EmbedBuilder } from 'discord.js';
import { joinVoiceChannel, createAudioPlayer, createAudioResource, AudioPlayerStatus, NoSubscriberBehavior } from '@discordjs/voice';
import ytdl from 'ytdl-core';
import express from 'express';
import { MusicQueue } from './queue.js';
import axios from 'axios';

const client = new Client({ intents: [GatewayIntentBits.Guilds, GatewayIntentBits.GuildVoiceStates, GatewayIntentBits.GuildMessages, GatewayIntentBits.MessageContent] });
const queue = new MusicQueue();
const player = createAudioPlayer({ behaviors: { noSubscriber: NoSubscriberBehavior.Pause } });
const app = express();
const PORT = process.env.PORT || 3000;

client.on('ready', () => {
    console.log(`Logged in as ${client.user.tag}`);
});

client.on('messageCreate', async message => {
    if (!message.guild) return;
    if (message.author.bot) return;

    const args = message.content.split(' ');
    const command = args.shift().toLowerCase();

    if (command === '!play') {
        const url = args[0];
        if (!url) return message.reply('Please provide a YouTube URL!');
        queue.add(url);
        message.reply(`Added to queue: ${url}`);
        playNext(message);
    }

    if (command === '!skip') {
        player.stop();
        message.reply('Skipped!');
    }

    if (command === '!queue') {
        const list = queue.list().join('\n') || 'Queue is empty!';
        message.reply(`Current Queue:\n${list}`);
    }
});

function playNext(message) {
    if (queue.list().length === 0) return;

    const channel = message.member.voice.channel;
    if (!channel) return message.reply('Join a voice channel first!');

    const connection = joinVoiceChannel({
        channelId: channel.id,
        guildId: message.guild.id,
        adapterCreator: message.guild.voiceAdapterCreator
    });

    const url = queue.next();
    const stream = ytdl(url, { filter: 'audioonly' });
    const resource = createAudioResource(stream);

    player.play(resource);
    connection.subscribe(player);

    player.once(AudioPlayerStatus.Idle, () => {
        if (queue.list().length > 0) playNext(message);
    });
}

// Express Web Interface
app.get('/', (req, res) => {
    res.send('<h1>Discord Music Bot 24/7 is running!</h1>');
});

// Keep-alive ping every 5 minutes
setInterval(() => {
    axios.get(`http://localhost:${PORT}`).catch(() => {});
}, 5 * 60 * 1000);

app.listen(PORT, () => console.log(`Web server running on port ${PORT}`));

client.login(process.env.DISCORD_TOKEN);
